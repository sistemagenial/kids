const f="https://profetadedeus.com.br/kids/api",p={STORIES:3e5,VIDEOS:3e5,USERS:18e4};function w(t,o){const r=localStorage.getItem(t),e=localStorage.getItem(`${t}_time`);if(r&&e){const n=Date.now(),s=parseInt(e,10);if(n-s<o)return console.log(`üì¶ Usando cache local: ${t}`),JSON.parse(r)}return null}function S(t,o){localStorage.setItem(t,JSON.stringify(o)),localStorage.setItem(`${t}_time`,Date.now().toString())}function A(t){Object.keys(localStorage).forEach(r=>{r.includes(t)&&localStorage.removeItem(r)})}async function c(t,o={}){try{console.log("üîç Fazendo requisi√ß√£o para:",`${f}${t}`);const r=await fetch(`${f}${t}`,{headers:{"Content-Type":"application/json",...o.headers},...o});console.log("üì° Status da resposta:",r.status);const e=await r.text();if(console.log("üìÑ Resposta recebida (primeiros 500 chars):",e.substring(0,500)),!e||e.trim()==="")throw console.error("‚ùå Resposta vazia do servidor"),new Error("Resposta vazia do servidor - verifique os logs do PHP");if(e.trim().startsWith("<!DOCTYPE")||e.trim().startsWith("<html"))throw console.error("‚ùå Servidor retornou HTML em vez de JSON:",e.substring(0,200)),new Error("Servidor retornou p√°gina HTML - poss√≠vel erro 404 ou 500");if(!r.ok){let n;try{n=JSON.parse(e)}catch{n={error:`HTTP ${r.status} - ${e.substring(0,100)}`}}throw new Error(n.error||`HTTP ${r.status}`)}try{const n=JSON.parse(e);if(console.log("‚úÖ JSON parseado com sucesso"),n.error)throw new Error(n.error);return n}catch(n){throw console.error("‚ùå Erro ao fazer parse do JSON:",n),console.error("üìÑ Texto recebido completo:",e),n instanceof Error?e.includes("Parse error")||e.includes("Fatal error")?new Error("Erro de sintaxe no PHP - verifique os logs do servidor"):e.includes("Warning")||e.includes("Notice")?new Error("Avisos PHP detectados - verifique a configura√ß√£o"):new Error(`Resposta inv√°lida do servidor: ${n.message}`):new Error("Resposta inv√°lida do servidor: erro desconhecido")}}catch(r){throw console.error("‚ùå Erro na requisi√ß√£o API:",r),r}}const z=async(t,o)=>{try{console.log("üîê Tentando login com:",{email:t,password:o.substring(0,3)+"***"});const r=await c("/users.php?action=login",{method:"POST",body:JSON.stringify({email:t,password:o})});if(r.data){const e={...r.data,id:String(r.data.id),license_count:Number(r.data.license_count),is_admin:!!r.data.is_admin};return console.log("‚úÖ Resultado do login normalizado:",e),{data:e,error:null}}return{data:r.data,error:null}}catch(r){return console.error("‚ùå Erro no login:",r.message),{data:null,error:r.message}}},k=async(t,o)=>{try{const r={...o};o.access_expires_at==="renew"&&(r.access_expires_at="renew");const e=await c("/users.php?action=update",{method:"PUT",body:JSON.stringify({id:t,...r})});return A("cached_user"),e.data?{data:{...e.data,id:String(e.data.id),license_count:Number(e.data.license_count),is_admin:!!e.data.is_admin},error:null}:{data:e.data,error:null}}catch(r){return{data:null,error:r.message}}},J=async()=>{try{const t="cached_stories",o=w(t,p.STORIES);if(o)return{data:o,error:null};const r=await c("/stories.php?action=all");if(r.data){const e=r.data.map(n=>({...n,id:String(n.id),order_number:n.order_number||n.position_number||1}));return S(t,e),{data:e,error:null}}return{data:r.data,error:null}}catch(t){return{data:null,error:t.message}}},B=async t=>{try{const o=`cached_story_${t}`,r=w(o,p.STORIES);if(r)return{data:r,error:null};const e=await c(`/stories.php?action=by-id&id=${encodeURIComponent(t)}`);if(e.data){const n={...e.data,id:String(e.data.id),order_number:e.data.order_number||e.data.position_number||1};return S(o,n),{data:n,error:null}}return{data:e.data,error:null}}catch(o){return{data:null,error:o.message}}},M=async()=>{try{const t="cached_videos",o=w(t,p.VIDEOS);if(o)return{data:o,error:null};const r=await c("/videos.php?action=all");if(r.data){const e=r.data.map(n=>({...n,id:String(n.id),order_number:n.order_number||n.position_number||1}));return S(t,e),{data:e,error:null}}return{data:r.data,error:null}}catch(t){return{data:null,error:t.message}}},F=async t=>{try{const o=`cached_video_${t}`,r=w(o,p.VIDEOS);if(r)return{data:r,error:null};const e=await c(`/videos.php?action=by-id&id=${encodeURIComponent(t)}`);if(e.data){const n={...e.data,id:String(e.data.id),order_number:e.data.order_number||e.data.position_number||1};return S(o,n),{data:n,error:null}}return{data:e.data,error:null}}catch(o){return{data:null,error:o.message}}},H=async t=>{try{return{data:(await c(`/devices.php?action=user-devices&user_id=${encodeURIComponent(t)}`)).data,error:null}}catch(o){return{data:null,error:o.message}}},V=async t=>{try{return{data:(await c("/devices.php?action=register",{method:"POST",body:JSON.stringify({...t,update_existing:!0})})).data,error:null}}catch(o){return{data:null,error:o.message}}},K=async(t,o)=>{try{const r=U();return{data:await c("/devices.php?action=remove",{method:"DELETE",body:JSON.stringify({user_id:t,device_id:o,session_token:r})}),error:null}}catch(r){return{data:null,error:r.message}}},L=async t=>{try{return{data:(await c("/orders.php?action=create",{method:"POST",body:JSON.stringify(t)})).data,error:null}}catch(o){return{data:null,error:o.message}}},U=()=>localStorage.getItem("session_token"),y="pd_kids_device_id_v5",j=()=>{const t=localStorage.getItem(y);if(t)return console.log("üì± Usando Device ID existente:",t.substring(0,30)+"..."),t;const r=(()=>{const n=document.createElement("canvas"),s=n.getContext("2d");let v="";s&&(s.textBaseline="top",s.font="14px Arial",s.fillText("PD Kids Device 2024",2,2),s.fillStyle="rgba(102, 204, 0, 0.7)",s.fillRect(100,5,62,20),v=n.toDataURL().slice(-50));const b=`${window.screen.width}x${window.screen.height}x${window.screen.colorDepth}x${window.screen.pixelDepth}`,E=Intl.DateTimeFormat().resolvedOptions().timeZone,D=navigator.languages?navigator.languages.join(","):navigator.language,x=navigator.platform,T=navigator.hardwareConcurrency||0,O=navigator.deviceMemory||0,$=navigator.maxTouchPoints||0,C=(()=>{try{const a=document.createElement("canvas"),i=a.getContext("webgl2")||a.getContext("webgl")||a.getContext("experimental-webgl");if(!i)return"unknown";const l=i.getExtension("WEBGL_debug_renderer_info"),_=l?i.getParameter(l.UNMASKED_RENDERER_WEBGL):"unknown";return`${l?i.getParameter(l.UNMASKED_VENDOR_WEBGL):"unknown"}-${_}`.slice(0,50)}catch{return"unknown"}})(),I=(()=>{try{const a=new(window.AudioContext||window.webkitAudioContext),i=a.createAnalyser();return`${a.sampleRate}-${a.destination.maxChannelCount}-${i.fftSize}`}catch{return"unknown"}})(),R=(()=>{const a=["Arial","Helvetica","Times","Courier","Verdana","Georgia","Palatino","Garamond","Bookman","Comic Sans MS","Trebuchet MS","Arial Black","Impact"],i="mmmmmmmmmmlli",l="72px",u=document.createElement("canvas").getContext("2d");if(!u)return"unknown";u.textBaseline="top",u.font=l+" monospace";const P=u.measureText(i).width;return a.filter(N=>(u.font=l+" "+N+", monospace",u.measureText(i).width!==P)).join(",").slice(0,30)})(),g=[v,b,E,D,x,T,O,$,C,I,R,navigator.userAgent.slice(0,100)].join("|");let d=0;for(let a=0;a<g.length;a++){const i=g.charCodeAt(a);d=(d<<5)-d+i,d=d&d}let m=5381;for(let a=0;a<g.length;a++)m=(m<<5)+m+g.charCodeAt(a);let h=0;for(let a=0;a<g.length;a++)h=g.charCodeAt(a)+((h<<5)-h);return`hw_${Math.abs(d).toString(36)}_${Math.abs(m).toString(36)}_${Math.abs(h).toString(36)}`})(),e=`${r}`;return localStorage.setItem(y,e),console.log("üì± Novo Device ID f√≠sico gerado:",{fingerprint:r.substring(0,30)+"...",finalId:e.substring(0,40)+"..."}),e},q=async(t,o,r)=>{try{console.log("üîÑ Atualizando nome do dispositivo:",{userId:t,deviceId:o,newName:r});const e=await fetch(`${f}/devices.php?action=update-name`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:t,device_id:o,name:r})});console.log("üì° Status da resposta:",e.status);const n=await e.text();if(console.log(" üìÑ Resposta recebida:",n),!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const s=JSON.parse(n);if(console.log("‚úÖ JSON parseado com sucesso:",s),s.error)throw new Error(s.error);return s}catch(e){throw console.error("‚ùå Erro ao atualizar nome do dispositivo:",e),e}};export{L as createPurchaseOrder,j as generateDeviceId,J as getAllStories,M as getAllVideos,U as getCurrentSessionToken,B as getStoryById,H as getUserDevices,F as getVideoById,z as loginUser,V as registerDevice,K as removeDevice,q as updateDeviceName,k as updateUser};
